<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GRIP Report Generator</title>
  <div style="margin:10px 0; padding:10px; border:1px solid #ccc; background:#f0f0f0; display:inline-block;">
    <label><strong>RTC Ticktes:</strong></label>
    <input type="number" id="totalTickets" value="0" style="width:80px; padding:4px;">
  </div>
   <style>
    body { font-family: Arial; margin: 20px; background: #f8f9fa; }
    h1, h2, h3 { color: #2F4F4F; }
    .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .form-row input, .form-row select { padding: 5px; font-size: 14px; flex: 1; min-width: 120px; }
    textarea { width: 100%; height: 80px; font-size: 14px; }
    button { padding: 8px 16px; background: #2F4F4F; color: white; border: none; margin-top: 10px; cursor: pointer; }
    button:hover { background: #1e2d2d; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
    th, td { border: 1px solid #f2f2f2; padding: 8px; word-wrap: break-word; text-align: left; }
    th { background-color: #d9d9d9; color: black; }
    .sanity-row { background-color: #e6f2ff; }
    .smoke-row { background-color: #fff3e6; }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    .ready-for-rc { background-color: #d4edda; }
    .in-qa { background-color: #d1ecf1; }
    .qa-blocked { background-color: #ffcccc; }
    .needs-refinement { background-color: #e2e3f3; }
    .reopened { background-color: #f9dcdc; }
    .logged-defect { background-color: #fbe8b7; }
    .added-zephyr { background-color: #e0f7da; }
    .failure-box { margin: 10px 0; padding: 8px; border: 1px solid #ccc; background: #fafafa; }
    .failure-box textarea { height: 50px; }
  </style>
  <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>GRIP Report Generator</h1>

  <label><strong>Date:</strong></label>
  <input type="date" id="reportDate" />

  <h2>Ticket Data</h2>
  <div id="ticketContainer"></div>
  <button onclick="addTicket()">‚ûï Add Ticket</button>

  <h2>üì• Or Upload Excel File</h2>
  <input type="file" id="excelUpload" accept=".xlsx, .xls" onchange="handleExcel(event)" />
  <p>
    <a href="GRIP_Report_Template.xlsx" download style="padding:8px 12px;background:#004080;color:#fff;text-decoration:none;border-radius:4px;">
      üìÑ Download Sample Template
    </a>
  </p>

  <h2>üìã Or Paste Table Data</h2>
  <textarea id="pastedData" placeholder="Paste data here in tab-separated format (like Excel copy)..."></textarea>
  <br>
  <button onclick="parsePastedData()">üì§ Paste & Load Data</button>

  <h2>Functional Status</h2>
  <textarea id="functionalStatus">Functional testing status will be updated here...</textarea>

  <h2>Automation Status</h2>
  <textarea id="automationStatus">
**Total test case automated:**
Automated [no of test cases] test cases today for _____________ [functionality]

**Test cases:**

**Update:** All test cases added in regression suite.
</textarea>

  <div style="margin-top:10px; padding:10px; border:1px solid #ccc; background:#fafafa;">
    <h3>Execution Summary</h3>
    <label>Sanity - Total: <input type="number" id="sanityTotal" value="0"></label>
    <label> Pass: <input type="number" id="sanityPass" value="0"></label>
    <label> Fail: <input type="number" id="sanityFail" value="0"></label>
    <div class="failure-box">
      <label>Sanity Failure Reason (if any):</label>
      <textarea id="sanityReason"></textarea>
    </div>
    <br>
    <label>Smoke - Total: <input type="number" id="smokeTotal" value="0"></label>
    <label> Pass: <input type="number" id="smokePass" value="0"></label>
    <label> Fail: <input type="number" id="smokeFail" value="0"></label>
    <div class="failure-box">
      <label>Smoke Failure Reason (if any):</label>
      <textarea id="smokeReason"></textarea>
    </div>
  </div>

  <br><button onclick="generateReport()">Generate Report</button>

  <div id="result" style="margin-top: 30px;"></div>

  <button onclick="downloadReport()" style="display:none;" id="downloadBtn">üì• Download HTML</button>

  <script>
    let ticketIndex = 0;
    const statuses = ["Ready for Release", "In QA","QA Blocked", "Needs Refinement", "Reopened", "To do(Backlog)", "Added to Zephyr"];

    function addTicket() {
      const container = document.getElementById("ticketContainer");
      const div = document.createElement("div");
      div.className = "form-row";
      div.innerHTML = `
        <input placeholder="Ticket ID" id="ticketId${ticketIndex}">
        <input placeholder="Title" id="title${ticketIndex}">
        <select id="status${ticketIndex}">
          ${statuses.map(s => `<option>${s}</option>`).join("")}
        </select>
        <input placeholder="Label" id="label${ticketIndex}">
        <input placeholder="Comment" id="comment${ticketIndex}">
      `;
      container.appendChild(div);
      ticketIndex++;
    }

    function handleExcel(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        document.getElementById("ticketContainer").innerHTML = "";
        ticketIndex = 0;
        json.forEach(row => {
          const div = document.createElement("div");
          div.className = "form-row";
          div.innerHTML = `
            <input value="${row['Ticket ID'] || ''}" placeholder="Ticket ID" id="ticketId${ticketIndex}">
            <input value="${row['Title'] || ''}" placeholder="Title" id="title${ticketIndex}">
            <select id="status${ticketIndex}">
              ${statuses.map(s => `<option${s === row['Status'] ? ' selected' : ''}>${s}</option>`).join("")}
            </select>
            <input value="${row['Label'] || ''}" placeholder="Label" id="label${ticketIndex}">
            <input value="${row['Comment'] || ''}" placeholder="Comment" id="comment${ticketIndex}">
          `;
          document.getElementById("ticketContainer").appendChild(div);
          ticketIndex++;
        });
        alert("Excel data loaded into form successfully!");
      };
      reader.readAsArrayBuffer(file);
    }

    function groupByStatus(tickets, status) {
      return tickets.filter(t => t.status === status);
    }

    function generateTable(tickets, cssClass = "") {
      if (!tickets.length) return "";
      let rows = tickets.map(t => `
        <tr class="${cssClass}">
          <td>${t.id}</td><td>${t.title}</td><td>${t.status}</td><td>${t.label}</td><td>${t.comment}</td>
        </tr>
      `).join("");
      return `<table>
        <tr><th>Ticket ID</th><th>Title</th><th>Status</th><th>Label</th><th>Comment (If any)</th></tr>
        ${rows}
      </table>`;
    }

    function generateReport() {
      const sanityTotal = document.getElementById("sanityTotal").value || 0;
      const sanityPass = document.getElementById("sanityPass").value || 0;
      const sanityFail = document.getElementById("sanityFail").value || 0;
      const sanityReason = document.getElementById("sanityReason").value || "";

      const smokeTotal = document.getElementById("smokeTotal").value || 0;
      const smokePass = document.getElementById("smokePass").value || 0;
      const smokeFail = document.getElementById("smokeFail").value || 0;
      const smokeReason = document.getElementById("smokeReason").value || "";

      const rawDate = document.getElementById("reportDate").value;
      if (!rawDate) {
        alert("Please select a date.");
        return;
      }
      const [yyyy, mm, dd] = rawDate.split("-");
      const formattedDate = `${dd}/${mm}/${yyyy}`;

      const automation = automationEditor ? automationEditor.getData().trim() : document.getElementById("automationStatus").value.trim();
      const functional = functionalEditor ? functionalEditor.getData().trim() : document.getElementById("functionalStatus").value.trim();

      let tickets = [];
      for (let i = 0; i < ticketIndex; i++) {
        const id = document.getElementById(`ticketId${i}`)?.value;
        const title = document.getElementById(`title${i}`)?.value;
        const status = document.getElementById(`status${i}`)?.value;
        const label = document.getElementById(`label${i}`)?.value;
        const comment = document.getElementById(`comment${i}`)?.value;
        if (id && title) {
          tickets.push({ id, title, status, label, comment });
        }
      }

      const totalTickets = document.getElementById("totalTickets").value || 0;

      let html = `<h1>GRIP Project Daily Status (${formattedDate})</h1>`;
      html += `<p><strong style="font-size:16px;">üìå Ready For QA Tickets: <span style="color:#004080;">${totalTickets}</span></strong></p>`;
      html += `<h2>üß™ Functional Testing</h2>`;

      const sections = [
        { label: "‚úÖ Ready for Release", status: "Ready for Release", class: "ready-for-rc" },
        { label: "üõ† Needs Refinement", status: "Needs Refinement", class: "needs-refinement" },
        { label: "üß™ In QA", status: "In QA", class: "in-qa" },
        { label: "‚õî QA Blocked", status: "QA Blocked", class: "qa-blocked" }, 
        { label: "üîÅ Reopened", status: "Reopened", class: "reopened" },
        { label: "üêû Logged Defects", status: "To do(Backlog)", class: "logged-defect" },
        { label: "üßæ Test Cases Added to Zephyr", status: "Added to Zephyr", class: "added-zephyr" }
      ];

      for (const section of sections) {
        const filtered = groupByStatus(tickets, section.status);
        if (filtered.length) {
          html += `<h3>${section.label}</h3>`;
          html += generateTable(filtered, section.class);
        }
      }

      if (functional) {
        html += `<h2>üß© Functional Status</h2><p>${functional}</p>`;
      }

      if (automation) {
        html += `<h2>ü§ñ Automation Testing</h2>`;
        html += `<h3>Automation Status</h3><p>${automation}</p>`;
        html += `<h3>Execution Summary</h3>
          <table>
            <tr><th>Suite</th><th>Total</th><th>Pass</th><th>Fail</th></tr>
            <tr class="sanity-row">
              <td><strong>Sanity</strong></td>
              <td><strong>${sanityTotal}</strong></td>
              <td class="pass">${sanityPass}</td>
              <td class="fail">${sanityFail}</td>
            </tr>
            <tr class="smoke-row">
              <td><strong>Smoke</strong></td>
              <td><strong>${smokeTotal}</strong></td>
              <td class="pass">${smokePass}</td>
              <td class="fail">${smokeFail}</td>
            </tr>
          </table>`;
        if (sanityReason) {
          html += `<p><strong>Sanity Failure Reason:</strong> ${sanityReason}</p>`;
        }
        if (smokeReason) {
          html += `<p><strong>Smoke Failure Reason:</strong> ${smokeReason}</p>`;
        }
      }

      document.getElementById("result").innerHTML = html;
      document.getElementById("downloadBtn").style.display = "inline-block";
    }

function downloadReport() {
  const rawDate = document.getElementById("reportDate").value;
  const [yyyy, mm, dd] = rawDate.split("-");
  const filename = `GRIP_Project_Daily_Status_${dd}_${mm}_${yyyy}.html`;

  // Collect ALL <style> tags
  const styles = Array.from(document.querySelectorAll("style"))
    .map(s => s.outerHTML)
    .join("\n");

  const content = document.getElementById("result").innerHTML;

  const htmlContent = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GRIP Project Daily Status</title>
${styles}
</head>
<body>
${content}
</body>
</html>`;

  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
}


    function parsePastedData() {
      const raw = document.getElementById("pastedData").value.trim();
      if (!raw) {
        alert("Please paste some data first.");
        return;
      }

      const lines = raw.split("\n").map(line => line.split("\t").map(cell => cell.trim()));
      if (lines.length < 2) {
        alert("Not enough data to parse.");
        return;
      }

      const headers = lines[0].map(h => h.toLowerCase());
      const headerMap = {
        id: headers.findIndex(h => h.includes("ticket id")),
        title: headers.findIndex(h => h.includes("title")),
        status: headers.findIndex(h => h.includes("status")),
        label: headers.findIndex(h => h.includes("label")),
        comment: headers.findIndex(h => h.includes("comment"))
      };

      if (headerMap.id === -1 || headerMap.title === -1 || headerMap.status === -1) {
        alert("Required columns (Ticket ID, Title, Status) not found.");
        return;
      }

      document.getElementById("ticketContainer").innerHTML = "";
      ticketIndex = 0;

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i];
        if (!row[headerMap.id] || !row[headerMap.title]) continue;

        let rawStatus = row[headerMap.status].toLowerCase().trim();
        let normalizedStatus = "Ready for Release";
        if (rawStatus === "qa blocked" || rawStatus.includes("blocked")) normalizedStatus = "QA Blocked"; 
        else if (rawStatus.includes("refine")) normalizedStatus = "Needs Refinement";
        else if (rawStatus.includes("in qa")) normalizedStatus = "In QA";
        else if (rawStatus.includes("rc")) normalizedStatus = "Ready for Release";
        else if (rawStatus.includes("defect") || rawStatus.includes("to do")) normalizedStatus = "To do(Backlog)";
        else if (rawStatus.includes("reopen")) normalizedStatus = "Reopened";
        else if (rawStatus.includes("add") || rawStatus.includes("zephyr")) normalizedStatus = "Added to Zephyr";

        const id = row[headerMap.id] || "";
        const title = row[headerMap.title] || "";
        const label = headerMap.label !== -1 ? (row[headerMap.label] || "") : "";
        const comment = headerMap.comment !== -1 ? (row[headerMap.comment] || "") : "";

        const div = document.createElement("div");
        div.className = "form-row";
        div.innerHTML = `
          <input value="${id}" placeholder="Ticket ID" id="ticketId${ticketIndex}">
          <input value="${title}" placeholder="Title" id="title${ticketIndex}">
          <select id="status${ticketIndex}">
            ${statuses.map(s => `<option${s === normalizedStatus ? ' selected' : ''}>${s}</option>`).join("")}
          </select>
          <input value="${label}" placeholder="Label" id="label${ticketIndex}">
          <input value="${comment}" placeholder="Comment" id="comment${ticketIndex}">
        `;
        document.getElementById("ticketContainer").appendChild(div);
        ticketIndex++;
      }

      alert("Pasted data loaded and normalized successfully!");
    }

    let functionalEditor, automationEditor;
    window.onload = () => {
      ClassicEditor.create(document.querySelector("#functionalStatus")).then(editor => { functionalEditor = editor; });
      ClassicEditor.create(document.querySelector("#automationStatus")).then(editor => { automationEditor = editor; });
    };
  </script>
</body>
</html>
